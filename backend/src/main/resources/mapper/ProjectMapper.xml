<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.bizsync.backend.mapper.ProjectMapper">

    <resultMap id="ProjectBoardMap"
               type="ProjectBoardDTO">
        <id property="projectId" column="project_id"/>
        <result property="name" column="project_name"/>
        <result property="totalBudget" column="total_budget"/>
        <result property="usedBudget" column="used_budget"/>
        <result property="startDate" column="start_date"/>
        <result property="endDate" column="end_date"/>
        <result property="status" column="status"/>

        <collection property="columns"
                    ofType="KanbanColumnDTO"
                    javaType="java.util.ArrayList">
            <id property="columnId" column="column_id"/>
            <result property="name" column="column_name"/>
            <result property="sequence" column="column_seq"/>
            <result property="columnType" column="column_type"/>

            <collection property="tasks"
                        ofType="TaskDTO"
                        javaType="java.util.ArrayList">
                <id property="taskId" column="task_id"/>
                <result property="title" column="task_title"/>
                <result property="content" column="task_content"/>
                <result property="sequence" column="task_seq"/>
                <result property="deadline" column="deadline"/>
                <result property="workerName" column="worker_name"/>
                <result property="workerId" column="worker_id"/>
            </collection>
        </collection>
    </resultMap>

    <select id="selectProjectBoard" resultMap="ProjectBoardMap">
        SELECT p.project_id,
               p.name     AS project_name,
               p.total_budget,
               p.used_budget,
               p.start_date,
               p.end_date,
               p.status,

               c.column_id,
               c.name     AS column_name,
               c.sequence AS column_seq,
               c.column_type,

               t.task_id,
               t.title    AS task_title,
               t.sequence AS task_seq,
               t.deadline,
               t.content  AS task_content,
               u.user_id  AS worker_id,
               u.name     AS worker_name

        FROM project p

                 LEFT JOIN kanban_column c ON p.project_id = c.project_id
                 LEFT JOIN task t ON c.column_id = t.column_id
                 LEFT JOIN users u ON t.worker_id = u.user_id

        WHERE p.project_id = #{projectId}

        ORDER BY c.sequence ASC, t.sequence ASC
    </select>

    <!-- 사용자가 멤버로 참여한 프로젝트 목록 조회 (N+1 문제 해결) -->
    <!-- CANCELLED 상태는 제외 (삭제된 프로젝트는 목록에 표시하지 않음) -->
    <select id="selectMyProjects" resultType="ProjectListResponseDTO">
        SELECT p.project_id   AS projectId,
               p.name         AS name,
               p.description  AS description,
               p.start_date   AS startDate,
               p.end_date     AS endDate,
               p.status       AS status,
               p.total_budget AS totalBudget,
               p.used_budget  AS usedBudget
        FROM project_member pm
                 INNER JOIN project p ON pm.project_id = p.project_id
        WHERE pm.user_id = #{userId}
          AND p.status != 'CANCELLED'
        ORDER BY p.project_id DESC
    </select>

</mapper>
